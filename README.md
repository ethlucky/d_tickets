# d_tickets

举办方不需要每次操作都进行链上操作，可以直接走线下签名的方式，具体的操作费用的话由平台来付，这样体验可能会更好点

场馆座位配置系统
座位价格配置系统

团体票，选票的可以在线选择多张票
个人票

## 1. 引言

### 1.1 项目背景

当前的票务市场面临诸多挑战：黄牛猖獗、假票泛滥、高昂的服务费以及缺乏透明度的二级转售市场。这些问题不仅损害了消费者的利益，也让主办方和艺术家蒙受损失。区块链技术的兴起为解决这些痛点提供了新的契机。Solana 区块链以其**高吞吐量、低交易费用和近乎即时的最终性**，为构建一个高效、公平、透明的去中心化票务系统提供了理想的基础。

### 1.2 项目目标

“闪电票务嘉年华”旨在利用 Solana 区块链的力量，打造一个颠覆性的票务解决方案，具体目标如下：

- **消除假票和黄牛：** 通过将每张门票铸造成唯一的 NFT，确保票务的真实性和所有权的不可篡改性，并设计合理的二级市场版税机制。
- **降低交易成本：** 借助 Solana 的低交易费用，显著降低用户购买和转售门票的成本。
- **提升用户体验：** 提供闪电般的购票和 NFT 分发速度，以及直观易用的界面。
- **增加市场透明度：** 所有票务流转和价格变动均记录在链上，公开透明可追溯。
- **赋能主办方：** 提供灵活的动态定价和票务管理工具，帮助主办方最大化收益并提升运营效率。
- **建立公平健康的二级市场：** 通过智能合约强制执行转售版税，确保艺术家和主办方在二级市场中持续获益。

### 1.3 范围定义

本文档详细描述了“闪电票务嘉年华”系统的核心功能需求、非功能性需求、用户角色及其职责划分，以及未来可能的拓展方向。本文档将作为项目开发的主要参考依据。

---

## 2. 用户角色与特点

本系统主要涉及三类用户角色：

### 2.1 最终用户 (购票者/门票持有者)

- **特点：** 希望方便、快捷、安全地购买到真实门票；可能对区块链技术了解不多，需要直观的用户界面；希望在必要时能便捷地转售门票或退票。
- **核心需求：**
    - 浏览和搜索活动。
    - 选择票种和座位。
    - 通过 Solana 钱包安全支付并即时收到 NFT 门票。
    - 在个人中心管理和查看已购门票 NFT。
    - 在安全的二级市场转售门票。
    - 在符合政策的情况下发起退票请求。
    - 方便快捷地通过 NFT 门票入场。

### 2.2 主办方 (活动组织者)

- **特点：** 寻求高效、透明的票务管理解决方案；希望最大化票务收入；对票务销售策略（如定价）有控制权；对防范黄牛和假票有强烈需求。
- **核心需求：**
    - 创建和发布活动（包括详细信息、宣传素材）。
    - 定义不同票种、价格和数量。
    - 选择和配置定价策略（固定价格或动态定价）。
    - 批量铸造活动门票 NFT。
    - 实时监控票务销售情况和库存。
    - 管理退票请求。
    - 收取票务销售款项及二级市场转售版税。

### 2.3 系统管理员 (平台运营方)

- **特点：** 负责平台的基础设施维护、合约部署、系统参数配置、安全监控等；确保平台稳定运行。
- **核心需求：**
    - 部署和升级智能合约。
    - 监控系统运行状态和链上交易。
    - 管理平台级参数和费用设置。
    - 处理潜在的安全事件或异常情况。

---

## 3. 核心功能模块与职责划分 (详细需求)

本系统主要由以下三个核心功能模块构成，每个模块都清晰地划分了链上（Solana 智能合约）和链下（前端应用）的职责。

### 3.1 票务 NFT 铸造与管理模块

该模块负责将现实世界的门票概念数字化为 Solana 区块链上的 NFT，并管理其生命周期。

#### **链上职责 (Solana 智能合约)**

- **活动基础数据结构定义：** 在链上定义活动的详细骨架，以支持丰富的现实场景需求：
    
    - `event_id`: 活动的唯一标识符（`string` 或 `u64`）。
    - `organizer_address`: 活动主办方的 Solana 钱包地址（`Pubkey`）。
    - `event_name`: 活动名称（例如：“周杰伦2025世界巡回演唱会 - 新加坡站”）（`string`）。
    - `event_description_hash`: 指向链下存储的活动详细描述文本的 IPFS/Arweave 哈希（`string`，例如 CID）。
    - `event_poster_image_hash`: 指向活动海报图片文件的 IPFS/Arweave 哈希（`string`）。
    - `event_start_time`: 活动开始的具体时间戳（`u64`，Unix Timestamp）。
    - `event_end_time`: 活动结束的具体时间戳（`u64`，Unix Timestamp）。
    - `ticket_sale_start_time`: 门票开始销售的时间戳（`u64`）。
    - `ticket_sale_end_time`: 门票销售结束的时间戳（`u64`）。
    - `venue_name`: 场馆名称（例如：“新加坡室内体育馆”）（`string`）。
    - `venue_address`: 场馆详细地址（`string`）。
    - `venue_capacity`: 场馆总容量（总座位或总站立人数）（`u32`）。
    - `event_category`: 活动分类（例如：“音乐会”、“戏剧”、“电影”、“体育赛事”等）（`string`）。
    - `performer_details_hash`: 指向表演者/剧团/电影制作方详细信息的 IPFS/Arweave 哈希（`string`）。
    - `contact_info_hash`: 指向主办方或客服联系方式的 IPFS/Arweave 哈希（`string`）。
    - `event_status`: 活动当前状态（例如：`upcoming`, `on_sale`, `sold_out`, `cancelled`, `postponed`, `completed`）（`enum`）。
    - `refund_policy_hash`: 指向活动退票政策详细文本的 IPFS/Arweave 哈希（`string`）。
    - `pricing_strategy_type`: 定义此活动采用的定价策略类型（例如：`FixedPrice`, `DynamicPricing`）（`enum`）。
    - `total_tickets_minted`: 已铸造的门票总数（`u32`）。
    - `total_tickets_sold`: 已售出的门票总数（`u32`）。
    - `total_tickets_refunded`: 已退款的门票总数（`u32`）。
    - `total_tickets_resale_available`: 退票后可再次销售的门票总数（`u32`）。
- **票种配置与存储：** 在链上定义并存储不同票种的详细参数，确保其不可篡改性。
    
    - `ticket_type_id`: 票种的唯一标识符（`u8` 或 `string`）。
    - `type_name`: 票种名称（例如：“VIP区”、“普通票A”、“二楼包厢”）（`string`）。
    - `initial_price`: 该票种的初始价格（`u64`，最小单位，例如 lamports）。
    - `current_price`: 该票种的当前售卖价格（动态定价时会更新）（`u64`）。
    - `total_supply`: 该票种的总发行数量（`u32`）。
    - `max_resale_royalty`: 该票种在二级市场转售时，可向原主办方/艺术家收取的最大版税比例（`u16`，例如 500 代表 5%）。
    - `is_fixed_price`: 布尔值，指示此票种是否采用固定价格策略（当活动选择固定价格策略时）。
    - `dynamic_pricing_rules_hash`: 指向链下存储的动态定价规则配置的哈希（当票种采用动态定价策略时）。
- **NFT 集合 (Collection) 管理：** 为每个活动创建或关联一个 NFT Collection，以便对该活动下的所有门票 NFT 进行逻辑分组和管理。这通常通过 Metaplex Candy Machine 或其他 NFT 程序实现。
    
- **门票 NFT 铸造 (Minting)：** 提供智能合约函数，允许授权的主办方根据定义的票种和数量，**批量铸造**（mint）唯一的门票 NFT。
    
    - 每个 NFT 都会拥有一个独特的 `token_id`。
    - NFT 会内嵌或关联关键属性，如 `event_id`、`ticket_type_id`、`seat_number` (如果适用，`string`)、`original_price`、`current_status` (例如 `valid`, `refunded`, `redeemed`, `resell_available` 等，`enum`)。
    - 每个 NFT 的**元数据哈希**（例如 IPFS CID）会上链存储，指向存储在去中心化存储服务上的详细元数据文件（包含门票图片、活动海报、详细描述等）。
    - 铸造出的 NFT 最初会存放在主办方的指定账户或由合约控制的临时账户中。
- **NFT 所有权追踪：** 智能合约会负责追踪每个门票 NFT 当前的所有者（即持有该 NFT 的 Solana 钱包地址）。这是由 Solana Token Program 和 NFT 标准自动提供的。
    
- **门票状态管理：** 智能合约维护门票 NFT 的状态，例如 `minted` (已铸造), `sold` (已售出), `transferred` (已转让), `redeemed` (已核销入场), `refunded` (已退款), `burned` (已销毁，用于非退款性销毁), `available_for_resale` (可二次售卖)。
    
- **退票功能 (Refund Mechanism) - 支持二次售卖：**
    
    - 提供一个由智能合约控制的**退票函数**，允许用户在满足特定退票政策条件（例如：在销售结束前，或活动取消时）时，发起退票请求。
    - **退票条件验证：** 智能合约将严格验证退票请求是否符合预设的 `refund_policy_hash` 指向的链下退票政策（例如：退票截止日期、是否已入场等）。
    - 当退票请求被智能合约验证通过后，智能合约会：
        1. 将该门票 NFT 的链上状态更新为 `refunded`，并更新其元数据中的 `current_status` 字段，明确表示该票已退款且无法再用于入场。
        2. 从主办方账户（或预设的退款资金池）中扣除相应金额（扣除可能的手续费或平台服务费），并**退还**给发起退退款的 NFT 持有者。
        3. **将已退票的 NFT 所有权临时转回到主办方账户**（或一个由合约控制的特定“回收”地址），同时将其链上状态更新为 `available_for_resale`。
        4. **增加该票种在链上记录的可用库存数量**，以便重新进入销售流程。
        5. 记录退票事件，包括退票时间、退款金额、退票人等。

#### **链下职责 (前端应用 / 后端服务)**

- **主办方管理界面 (Dashboard)：** 提供直观的用户界面，允许主办方创建新活动、填写活动详情（包括所有新增的丰富字段）、上传宣传素材（海报、视频等）。
- **票种与座位配置界面：** 允许主办方定义不同票种的名称、描述、初始价格、总数量。对于有固定座位的场馆，提供可视化座位图编辑器，将座位与特定票种 NFT 关联。
- **定价策略选择与配置界面：** 在活动创建时，为主办方提供下拉菜单或选项，选择该活动采用**“固定价格策略”**或**“动态价格策略”**。
    - 如果选择**固定价格**，则只需输入每种票的固定售卖价格。
    - 如果选择**动态价格**，则引导配置动态定价规则（如销售百分比阈值、时间点调整等）。前端负责将这些配置参数格式化并传递给智能合约的初始化或更新函数。
- **元数据上传与管理：** 负责将图片、视频、详细描述文本（如退票政策）、艺人信息等非结构化数据上传至 IPFS 或 Arweave 等去中心化存储服务，并获取其内容标识符 (CID)。
- **交易指令构建与发送：** 使用 Solana Web3.js SDK 或相关库，根据主办方在前端输入的信息，构建并签署调用智能合约铸造 NFT、配置活动等交易指令。
- **链上数据查询与展示：** 从 Solana 区块链查询已铸造的 NFT 数量、活动状态、已售票量、**已退票并重新上架的票量**、销售总额等信息，并在前端界面实时展示给主办方。
- **钱包交互：** 管理主办方钱包的连接，以便进行合约部署和交易签名。

### 3.2 动态定价智能合约模块

该模块负责根据预设的规则和市场实时数据，自动化地调整门票价格，实现灵活的票务销售策略。

#### **链上职责 (Solana 智能合约)**

- **定价策略类型判断：** 智能合约在处理购买请求时，会首先检查该活动在链上定义的 `pricing_strategy_type` 字段，以决定采用哪种定价逻辑。
- **固定价格策略 (FixedPrice) 逻辑：**
    - 如果 `pricing_strategy_type` 为 `FixedPrice`，智能合约将直接使用票种在链上定义的 `initial_price` 作为唯一的售卖价格，不进行任何动态调整。
- **动态定价规则存储：** 智能合约内部存储主办方配置的动态定价规则，如：
    - **基于销量的阶梯定价：** `[销售百分比阈值, 价格调整比例]` 数组，例如 `[[50%, +5%], [75%, +10%]]`。
    - **基于时间的定价：** `[时间点, 价格调整比例]`，例如 `[[活动开始前7天, +5%], [活动开始前24小时, +10%]]`。
    - **最高价/最低价限制：** 为每个票种设定价格的上下限，防止价格过度波动。
- **实时票价计算逻辑 (DynamicPricing)：** 智能合约内含复杂的算法，当 `pricing_strategy_type` 为 `DynamicPricing` 时，它能够：
    - **获取实时数据：** 查询本活动下特定票种的**实时已售票数**和**剩余票数**（包括退票后重新上架的票）。
    - **评估触发条件：** 根据当前已售百分比和当前时间点，与预设的动态定价规则进行比较，判断是否达到价格调整的触发条件。
    - **计算新价格：** 如果触发条件满足，智能合约会自动计算出新的票价。
- **价格状态更新：** 智能合约会更新链上存储的，**当前有效的票价**。一旦更新，该价格会立即用于所有新的购买请求。
- **（可选）预言机集成：** 如果需要引入链下数据（如艺人实时热度、外部市场数据）来影响价格，智能合约需要集成 Solana 生态中兼容的预言机服务（如 Pyth Network）。

#### **链下职责 (前端应用 / 后端服务)**

- **定价策略配置界面：** 提供给主办方配置各种动态定价规则的用户界面（例如，滑动条设置百分比，日历选择时间点）。前端负责将这些配置参数格式化并传递给智能合约的初始化或更新函数。
- **实时价格展示：** 前端通过 Solana Web3.js SDK **调用智能合约**，查询当前生效的票价，并将其在用户购买界面实时展示。前端本身不进行价格计算，只负责展示合约返回的最新价格。
- **价格变动历史展示：** 从链上交易日志或事件（Events）来获取价格调整的历史记录，并在前端以图表或列表形式展示给用户，增加透明度。
- **用户通知：** 当价格发生变动时，前端可以向用户发送弹窗或推送通知。

### 3.3 用户购买与 NFT 分发界面

该模块是最终用户与票务系统直接交互的界面，负责引导用户完成门票选择、支付以及 NFT 接收的全过程，并体现 Solana 的极速特性。

#### **链上职责 (Solana 智能合约)**

- **门票购买函数：** 核心交易逻辑。当用户发起购买时，智能合约会执行以下关键步骤：
    - **验证支付：** 验证用户支付的 SOL 或稳定币金额是否与当前票价匹配。
    - **库存检查：** 检查所选票种是否有足够的库存（包括原始库存和退票后重新上架的票）。
    - **资金接收：** 将用户支付的 SOL 或稳定币安全地转移到主办方指定账户。
    - **NFT 所有权转移：** **将对应的门票 NFT 从主办方账户（或合约控制的临时地址）转移到用户指定的 Solana 钱包地址。**
    - **库存扣减：** 链上更新对应票种的已售数量。
- **交易原子性：** 确保购买操作是原子性的——要么全部成功（支付完成，NFT 到账），要么全部失败（资金退回，NFT 不变）。
- **安全防范：** 内置防重入攻击、双花等安全机制。
- **入场核销：** 提供智能合约函数，允许授权的验票员或设备通过扫描 NFT（验证其在链上的状态）来核销门票，并将其状态更新为 `redeemed`，防止重复使用。

#### **链下职责 (前端应用)**

- **活动浏览与详情：** 提供直观的用户界面，展示所有可购买的活动列表。用户可以点击进入活动详情页，查看活动介绍、海报、视频、不同票种信息、**当前价格（根据所选定价策略）**和剩余票量（包括退票后重新上架的）。
- **选票与选座：**
    - **票种选择器：** 用户选择 desired 票种和数量。
    - **交互式座位图 (如果适用)：** 对于有固定座位的活动，提供一个用户友好的交互式座位图，显示可用座位（包括退票后重新可售的座位），并允许用户选择。
- **Solana 钱包连接：** 提供多种兼容 Solana 的钱包（如 Phantom, Solflare, Backpack 等）连接选项，方便用户进行身份验证和交易签名。
- **订单摘要与确认：** 在用户确认购买前，展示清晰的订单摘要，包括所选票种、数量、单价、总价、预计交易费用等。
- **交易构建与签名：** 根据用户选择的票种和数量，使用 Solana Web3.js SDK 组装调用智能合约购买函数的交易。将交易发送到用户钱包进行签名。
- **交易发送与监听：** 将签名后的交易发送到 Solana 网络。监听交易状态，并向用户提供实时反馈（“正在处理中…”, “等待区块链确认！”）。
- **NFT 即时分发通知：** 一旦交易在链上成功确认（Solana 通常在几秒内），前端立即向用户显示“购买成功！您的门票 NFT 已发送至您的钱包”的通知。
- **“我的门票”页面：** 用户登录后，可以查看其钱包中持有的所有门票 NFT 列表，包括活动的详细信息、座位号、入场二维码/凭证（需要前端生成可供扫描的二维码或条形码，其内容关联到链上 NFT ID 或用户钱包地址）。
- **退票请求发起：** 在“我的门票”页面，用户可以针对符合退票政策的门票发起退票请求。前端会调用智能合约的退票函数，并指导用户完成退票流程。
- **错误处理与用户引导：** 友好的错误提示，引导用户解决交易失败、网络问题、钱包连接中断等情况。

---

## 4. 非功能性需求

### 4.1 性能

- **交易吞吐量：** 系统需支持每秒至少 1000 次购买交易，以应对高并发抢票场景。
- **交易确认时间：** 购买、转售、退票等关键交易的最终确认时间应在 5 秒以内。
- **数据查询延迟：** 前端从链上查询数据（如剩余票数、当前价格）的延迟应低于 2 秒。
- **页面加载速度：** 前端页面加载和交互应流畅，响应时间应小于 3 秒。

### 4.2 安全性

- **智能合约审计：** 所有核心智能合约在部署前必须经过专业的第三方安全审计。
- **防欺诈：** NFT 的唯一性从根本上杜绝假票。二级市场的智能合约强制版税和所有权转移，防止黄牛囤积和恶意炒作。
- **私钥安全：** 系统不会托管用户私钥。所有链上操作均通过用户钱包签名，确保用户资金和资产安全。
- **抗女巫攻击：** 考虑在特定场景下（如社区投票）加入防女巫攻击机制。
- **抗 DDoS 攻击：** 前端和链下服务需具备相应的抗 DDoS 能力。

### 4.3 可用性与用户体验 (UX)

- **易用性：** 界面设计简洁直观，即使对区块链不熟悉的用户也能轻松上手。
- **兼容性：** 支持主流浏览器和 Solana 钱包（如 Phantom, Solflare, Backpack）。
- **移动端适配：** 界面需响应式设计，良好适配移动设备。
- **国际化：** 考虑未来支持多语言。
- **可访问性：** 遵循无障碍设计原则。

### 4.4 可靠性

- **系统正常运行时间：** 核心智能合约应保持 99.99% 的可用性（由 Solana 网络保证）。前端及链下服务目标 99.5% 以上。
- **数据持久性：** 所有链上数据（NFT 记录、交易历史）永久存储在 Solana 区块链上。链下元数据存储在 IPFS/Arweave 等去中心化存储。
- **错误恢复：** 系统应具备从部分故障中恢复的能力，并提供清晰的错误提示和重试机制。

### 4.5 可扩展性

- **水平扩展：** 前端和链下服务架构设计应支持根据用户量增长进行水平扩展。
- **合约升级能力：** 智能合约应考虑可升级性，以便在不影响现有资产的情况下修复漏洞或添加新功能。
- **多链兼容性（未来）：** 考虑未来与其他区块链（如 EVM 兼容链）的互操作性。

### 4.6 审计性与透明度

- **链上记录：** 所有核心业务逻辑和数据均记录在 Solana 区块链上，可公开查询和审计。
- **交易可追溯：** 每一张门票 NFT 的生命周期（铸造、销售、转售、退票、核销）均可追溯。

---

## 5. 架构概述 (高层)

### 5.1 链上架构

- **Solana 程序 (Smart Contracts)：** 使用 Rust 语言编写，编译为 BPF 字节码，部署在 Solana 网络上。主要程序包括：
    - **Event & Ticket Management Program：** 处理活动创建、票种定义、NFT 铸造、库存管理、门票状态更新（包括退票和重新上架）。
    - **Pricing Strategy Program：** 处理固定价格和动态定价的逻辑，负责实时价格计算和更新。
    - **Sales & Transfer Program：** 处理门票购买、支付处理、NFT 所有权转移。
    - **Secondary Marketplace Program：** 处理 NFT 门票的二级转售挂单、匹配和交易执行（包含版税分配）。
    - **Redemption Program (可选)：** 用于入场核销的智能合约逻辑。
- **SPL Tokens & NFTs：** 利用 Solana Program Library (SPL) 的 Token Program 实现 NFT 和可替代代币（如 SOL 或 USDC）的发行和管理。使用 Metaplex 标准用于 NFT 元数据管理。

### 5.2 链下架构

- **前端应用：** 基于 React/Vue/Angular 等现代前端框架开发，使用 Solana Web3.js SDK 与链上智能合约进行交互。
- **去中心化存储：** IPFS / Arweave 用于存储 NFT 元数据、活动海报、详细描述、退票政策等静态内容。
- **Solana RPC 节点：** 前端直接或通过中间件连接到 Solana RPC 节点，进行链上数据查询和交易提交。
- **（可选）索引服务：** 为了提供更高效的链上数据查询和复杂聚合（例如，所有活动的历史销售数据），可以考虑使用 Solana 索引器（如 Helius, QuickNode 的 Data API 或自定义索引服务）。
- **（可选）后端服务：** 用于提供一些不适合链上处理的功能，如用户认证（非钱包）、邮件通知、数据缓存等。

---

## 6. 未来展望 (Roadmap)

### 6.1 短期 (马拉松项目阶段)

- 完成核心功能 MVP (Minimum Viable Product)：包括活动创建、NFT 铸造、固定价格销售、基本的动态定价（基于销量或时间）、NFT 购买与分发、退票及二次售卖。
- 基本用户界面和主办方后台。
- 合约测试和初步安全审计。

### 6.2 中期 (MVP 发布后)

- **更高级的动态定价策略：** 引入基于需求量、外部市场数据（通过预言机）的定价。
- **社群功能：** 引入社区票务提案、投票决定演出等去中心化自治组织 (DAO) 元素。
- **忠诚度计划：** 门票 NFT 持有者奖励（如专属内容、折扣、空投）。
- **更完善的二级市场：** 竞价机制、批量转售、更灵活的版税设置。
- **多票种组合销售：** 允许用户一次购买多个票种或套餐。
- **移动应用：** 开发 iOS/Android 移动端应用。
- **多语言支持。**

### 6.3 长期 (生态系统发展)

- **互操作性：** 探索与其他区块链或票务平台的跨链解决方案。
- **数字收藏品整合：** 门票 NFT 作为未来数字身份或收藏品生态的一部分。
- **更多活动类型支持：** 如会议、展览、在线课程等。
- **全球市场扩展。**

---

## 7. 假设与约束

### 7.1 假设

- 用户拥有 Solana 钱包并了解基本操作。
- IPFS/Arweave 等去中心化存储服务稳定可用。
- Solana 网络保持高吞吐量和低交易费用。
- 主办方愿意接受并使用区块链技术进行票务管理。

### 7.2 约束

- **时间限制：** 马拉松项目有严格的时间限制，需优先实现核心功能。
- **资源限制：** 开发团队规模和可用资源有限。
- **安全风险：** 智能合约存在潜在漏洞风险，需要严格测试和审计。
- **监管不确定性：** 区块链和 NFT 票务在全球范围内的法律法规仍在发展中。

主办方座位配置功能：可视化与自动化

主办方需要一个强大的后台工具来定义场馆布局、划分票区、设置座位，并将这些信息与链上的票种和 NFT 关联起来。

#### 1. 场馆平面图上传与管理

- **上传平面图：** 主办方可以上传一个**矢量图（SVG 格式推荐）或高分辨率位图（PNG/JPG）作为场馆的基础平面图**。矢量图更便于后续的交互式编辑和缩放。
- **场馆信息：** 录入场馆名称、地址、总容量等基础信息。
- **多场馆支持：** 如果主办方有多个常用的场馆，系统应允许其管理和保存多个场馆的平面图和座位配置。

#### 2. 可视化座位图编辑器

这是一个核心功能，旨在让主办方像使用设计软件一样直观地配置座位。

- **区域划分工具：**
    - 主办方可以在上传的平面图上，使用**拖拽工具（例如多边形或矩形工具）绘制并定义不同的票区**（例如“VIP区”、“A区”、“B区”、“站立区”）。
    - 每个区域可以命名（如“看台1区”、“内场VIP”）。
- **座位布局工具：**
    - **自动生成座位：** 在已定义的区域内，主办方可以设置座位行的起始排号、座位起始号，然后系统**自动生成标准排布的座位网格**。例如，设置“A排，座位号1-20”，系统会在该排生成20个座位。
    - **手动调整/绘制：** 允许主办方**拖动、旋转、删除单个座位或座位组**，以适应不规则的场馆布局。对于散座或自由座位的区域，可以只定义区域而不画具体座位。
    - **座位类型/状态标记：** 允许为主办方标记一些特殊座位，例如“无障碍座位”、“保留座位”、“通道”等，这些座位在用户购票时不可选。
- **票种与区域/座位关联：**
    - 主办方可以将之前创建的**“票种”拖拽到已定义的区域上**，表示该区域的座位属于此票种，并继承其价格和属性。
    - 也可以为单个座位指定特定的票种（例如，某些特殊包厢的座位可能属于独特的票种）。
    - 系统会实时显示每个票种关联的座位数量，并与该票种的总供应量进行核对。
- **颜色编码与预览：**
    - 在编辑模式下，不同区域或不同票种的座位可以显示不同的颜色，便于主办方区分。
    - 提供**“用户视角预览”**模式，让主办方查看购票者将看到的座位图效果。

#### 3. 座位数据存储与链上关联

- **链下存储座位图布局：**
    - 编辑器生成的**座位图布局数据**（通常是 JSON 格式，包含每个座位的坐标、排号、座位号、所属区域、票种ID等详细信息）将**上传到 IPFS/Arweave 等去中心化存储服务**。
    - 其对应的哈希值 (`seat_map_hash`) 会存储在链上活动的**`Event`数据结构**中。
- **链上座位状态追踪：**
    - 虽然详细的布局在链下，但每个**具体座位的可用状态**（`available`, `sold`, `refunded`, `redeemed`, `temp_locked`）都需要在链上智能合约中精确追踪。
    - 在铸造 NFT 门票时，每个 NFT 都会绑定一个唯一的 `seat_number`。
    - 当座位被购买、退票或核销时，智能合约会**原子性地更新该 `seat_number` 的链上状态**。
    - 为了高效查询和更新特定座位的状态，智能合约可能需要维护一个座位状态的映射或索引。

#### 4. 发布与同步

- **保存草稿：** 主办方可以随时保存座位配置的草稿。
- **发布活动：** 当主办方满意座位配置后，可以**“发布活动”**。此时，前端会：
    1. 将最新的座位图布局数据上传到 IPFS/Arweave，并获取新的 `seat_map_hash`。
    2. 构建一个Solana交易，调用智能合约来**批量铸造所有定义好的门票 NFT**，确保每个 NFT 都带有对应的 `seat_number` 和 `ticket_type_id`。
    3. 更新链上活动数据中的 `seat_map_hash`，并正式将活动状态设置为“可售”。
    4. 智能合约会根据铸造的门票数量，初始化或更新链上每个座位的状态。

### 5. 挑战与考虑

- **复杂座位图处理：** 对于形状不规则、座位号跳跃的场馆，编辑器的智能化程度和灵活性是关键。
- **链上存储成本：** 虽然单个座位的状态可以在链上高效存储，但如果座位数量巨大（例如十万级），需优化数据结构以最小化链上存储成本和查询复杂性。
- **性能：** 大规模座位图的渲染和交互需要前端有良好的性能优化。
- **版本控制：** 座位图配置可能需要修改，系统应能处理不同版本的座位图，并确保已售门票的兼容性。

通过以上功能，主办方将能够高效、直观地配置活动的座位，为购票者提供完美的选座体验！


